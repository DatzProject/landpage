import React, { useState, useEffect } from 'react';

const StudentAttendanceApp = () => {
  const [students, setStudents] = useState([
    { id: 1, name: 'Ahmad Rizki', kelas: 'X-A', nisn: '001234567890' },
    { id: 2, name: 'Siti Nurhaliza', kelas: 'X-A', nisn: '001234567891' },
    { id: 3, name: 'Budi Santoso', kelas: 'X-B', nisn: '001234567892' },
    { id: 4, name: 'Dewi Sartika', kelas: 'X-B', nisn: '001234567893' },
    { id: 5, name: 'Eko Prasetyo', kelas: 'XI-A', nisn: '001234567894' },
  ]);

  const [attendance, setAttendance] = useState({});
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [selectedClass, setSelectedClass] = useState('Semua');
  const [searchTerm, setSearchTerm] = useState('');

  const attendanceStatus = ['Hadir', 'Izin', 'Sakit', 'Alpha'];
  const classes = ['Semua', 'X-A', 'X-B', 'XI-A'];

  useEffect(() => {
    const today = selectedDate;
    if (!attendance[today]) {
      const todayAttendance = {};
      students.forEach(student => {
        todayAttendance[student.id] = 'Hadir';
      });
      setAttendance(prev => ({ ...prev, [today]: todayAttendance }));
    }
  }, [students, selectedDate]);

  const handleAttendanceChange = (studentId, status) => {
    setAttendance(prev => ({
      ...prev,
      [selectedDate]: {
        ...prev[selectedDate],
        [studentId]: status
      }
    }));
  };

  const getAttendanceStatus = (studentId) => {
    return attendance[selectedDate]?.[studentId] || 'Hadir';
  };

  const filteredStudents = students.filter(student => {
    const matchClass = selectedClass === 'Semua' || student.kelas === selectedClass;
    const matchSearch = student.name.toLowerCase().includes(searchTerm.toLowerCase()) || student.nisn.includes(searchTerm);
    return matchClass && matchSearch;
  });

  const handleSaveToSheet = async () => {
    const endpoint = 'https://script.google.com/macros/s/AKfycbxB_04QTjqWox9-1qkDFRdDKCj44nCpexwPSm0vGsFF0Fs-SZpyp2gvjaONPLQNSQTz/exec';

    const dataToSend = filteredStudents.map(student => ({
      tanggal: selectedDate,
      nama: student.name,
      kelas: student.kelas,
      nisn: student.nisn,
      status: getAttendanceStatus(student.id)
    }));

    try {
      await fetch(endpoint, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      });

      alert('✅ Absensi berhasil dikirim ke Google Sheet!');
    } catch (error) {
      console.error('❌ Gagal kirim absensi:', error);
      alert('Gagal mengirim data. Silakan periksa koneksi atau URL Web App.');
    }
  };

  return (
    <div className="max-w-3xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">Absensi Siswa ({filteredStudents.length} siswa)</h1>

      <div className="mb-4 flex flex-wrap gap-4">
        <input
          type="date"
          value={selectedDate}
          onChange={e => setSelectedDate(e.target.value)}
          className="p-2 border rounded"
        />
        <select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="p-2 border rounded">
          {classes.map(cls => (
            <option key={cls} value={cls}>{cls}</option>
          ))}
        </select>
        <input
          type="text"
          placeholder="Cari siswa..."
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          className="p-2 border rounded flex-1"
        />
      </div>

      <div className="space-y-3 mb-6">
        {filteredStudents.map(student => (
          <div key={student.id} className="flex justify-between items-center bg-gray-100 p-3 rounded">
            <div>
              <p className="font-semibold">{student.name}</p>
              <p className="text-sm text-gray-600">{student.kelas} • NISN: {student.nisn}</p>
            </div>
            <div className="flex gap-1">
              {attendanceStatus.map(status => (
                <button
                  key={status}
                  onClick={() => handleAttendanceChange(student.id, status)}
                  className={`px-3 py-1 rounded text-sm font-medium ${
                    getAttendanceStatus(student.id) === status
                      ? 'bg-green-500 text-white'
                      : 'bg-white border'
                  }`}
                >
                  {status}
                </button>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="text-center">
        <button
          onClick={handleSaveToSheet}
          className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded font-bold"
        >
          ✅ Simpan Absensi
        </button>
      </div>
    </div>
  );
};

export default StudentAttendanceApp;
